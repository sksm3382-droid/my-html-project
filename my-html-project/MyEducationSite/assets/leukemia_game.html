<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‹¤ì˜¨ì´ì˜ íë§ ëª¨í—˜</title>
  <style>
    body {
      font-family: "Pretendard", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fef6ff;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    #game {
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      width: 90%;
      max-width: 700px;
      padding: 24px 24px 28px;
      box-sizing: border-box;
    }

    .title {
      font-size: 26px;
      font-weight: 800;
      text-align: center;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      text-align: center;
      color: #666;
      margin-bottom: 20px;
    }

    .scene-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .scene-subtitle {
      font-size: 14px;
      color: #777;
      margin-bottom: 16px;
    }

    .character {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .dialog-box {
      background: #fff7ff;
      border-radius: 16px;
      padding: 12px 14px;
      margin-bottom: 14px;
      font-size: 15px;
      line-height: 1.5;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      background: #ffd6f5;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      white-space: nowrap;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 12px rgba(0,0,0,0.12);
      background: #ffc2ef;
    }

    button.primary {
      background: #ff9fd8;
      font-weight: 600;
    }

    button.primary:hover {
      background: #ff89cf;
    }

    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #ffe7ff;
      font-size: 11px;
      color: #aa5fb5;
      margin-bottom: 10px;
    }

    .progress {
      font-size: 12px;
      color: #999;
      text-align: right;
      margin-bottom: 6px;
    }

    .list {
      font-size: 14px;
      margin: 8px 0 4px;
      padding-left: 18px;
    }

    .feedback {
      margin-top: 10px;
      font-size: 14px;
      font-weight: 600;
    }

    .feedback.good {
      color: #2c9a4b;
    }

    .feedback.bad {
      color: #d23b3b;
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f2f2ff;
      font-size: 12px;
      margin: 2px 4px 0 0;
    }

    .small-label {
      font-size: 11px;
      color: #777;
      margin-top: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 12px;
    }

    th, td {
      border-bottom: 1px solid #eee;
      padding: 4px 3px;
      text-align: center;
    }

    th {
      background: #faf5ff;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div id="game">
    <div class="title">ë‹¤ì˜¨ì´ì˜ íë§ ëª¨í—˜</div>
    <div class="subtitle">ë°±í˜ˆë³‘ ì´í•´ Â· ìê°€ê´€ë¦¬ Â· ì¹˜ë£Œ í˜‘ì¡° Â· ë§ˆìŒ í‘œí˜„ ê²Œì„</div>
    <div id="screen"></div>
  </div>

  <script>
    const state = {
      step: 0,
      scoreUnderstanding: 0,
      scoreSelfCare: 0,
      scoreCooperation: 0
    };

    const STORAGE_KEY = "healingHeroResults";

    /* ğŸµ ì½”ë“œë¡œ ë§Œë“œëŠ” ê²Œì„ ë°°ê²½ ë©œë¡œë”” */
    let audioCtx = null;
    let bgmInterval = null;
    let bgmNoteIndex = 0;

    // ë” í¥ë¯¸ì§„ì§„í•œ ê²Œì„ ëŠë‚Œ ë©œë¡œë”” (ì¥ë‚œê° ê²Œì„ BGM ëŠë‚Œ)
    const MELODY_NOTES = [
      659.25, 784.0, 880.0, 784.0,  // E5 A5 C6 A5
      659.25, 587.33, 523.25,       // E5 D5 C5
      698.46, 784.0, 932.33, 880.0, // F5 A5 Bb5 A5
      784.0, 659.25, 523.25         // A5 E5 C5
    ];

    function initAudio() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        audioCtx = new AC();
      }
    }

    function playOneNote(freq, duration = 0.25) {
      if (!audioCtx) return;
      audioCtx.resume();
      const ctx = audioCtx;
      const now = ctx.currentTime;

      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.frequency.value = freq;
      osc.type = "triangle"; // ì¡°ê¸ˆ ë” ë§‘ì€ ê²Œì„ ëŠë‚Œ

      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(0.18, now + 0.05);
      gain.gain.linearRampToValueAtTime(0.0, now + duration);

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start(now);
      osc.stop(now + duration + 0.05);
    }

    function startBgm() {
      initAudio();
      if (!audioCtx) return;
      if (bgmInterval) return; // ì´ë¯¸ ì¬ìƒ ì¤‘ì´ë©´ ë˜ ì•ˆ ì¼œê¸°

      bgmNoteIndex = 0;
      bgmInterval = setInterval(() => {
        const freq = MELODY_NOTES[bgmNoteIndex];
        playOneNote(freq, 0.25);
        bgmNoteIndex = (bgmNoteIndex + 1) % MELODY_NOTES.length;
      }, 320); // 0.32ì´ˆë§ˆë‹¤ í•œ ìŒì”© -> ê²½ì¾Œí•œ í…œí¬
    }

    function stopBgm() {
      if (bgmInterval) {
        clearInterval(bgmInterval);
        bgmInterval = null;
      }
      if (audioCtx) {
        audioCtx.suspend();
      }
    }

    /* ğŸ”Š ì¹­ì°¬/ê²©ë ¤ ìŒì„± (ë” ë†’ì€ í”¼ì¹˜) */
    function playVoice(text, mode = "normal") {
      if (!("speechSynthesis" in window)) return;

      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "ko-KR";

      if (mode === "correct") {
        utter.pitch = 1.7;   // ë” ë†’ì€ ìŒì—­
        utter.rate = 1.15;   // ì‚´ì§ ë¹ ë¥´ê²Œ
        utter.volume = 1.0;
      } else if (mode === "wrong") {
        utter.pitch = 1.3;   // ì•½ê°„ ë†’ê³  ë¶€ë“œëŸ¬ìš´ í†¤
        utter.rate = 1.0;
        utter.volume = 1.0;
      } else {
        utter.pitch = 1.0;
        utter.rate = 1.0;
        utter.volume = 1.0;
      }

      window.speechSynthesis.speak(utter);
    }

    function setScreen(html) {
      document.getElementById("screen").innerHTML = html;
    }

    function loadResults() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
        return [];
      } catch (e) {
        return [];
      }
    }

    function saveResult(result) {
      const list = loadResults();
      list.push(result);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function startGame() {
      state.step = 1;
      state.scoreUnderstanding = 0;
      state.scoreSelfCare = 0;
      state.scoreCooperation = 0;

      // ê²Œì„ ì‹œì‘í•  ë•Œ ë©œë¡œë”” ì‹œì‘
      startBgm();
      showIntro();
    }

    // 0. ì²« í™”ë©´
    function showStartScreen() {
      // ì‹œì‘ í™”ë©´ì—ì„œëŠ” ë©œë¡œë”” ë”
      stopBgm();

      setScreen(`
        <div class="dialog-box">
          <div class="character">ğŸŒˆ ë‹¤ì˜¨ì´</div>
          <div>
            "ì•ˆë…•! ë‚˜ëŠ” ë°±í˜ˆë³‘ì„ ì¹˜ë£Œ ì¤‘ì¸ ë‹¤ì˜¨ì´ì•¼.<br>
            ê°™ì´ ë‚´ ëª¸ì„ ì§€ì¼œì£¼ëŠ” íˆì–´ë¡œê°€ ë˜ì–´ ì¤„ë˜?"
          </div>
        </div>
        <div class="button-row" style="justify-content:center;">
          <button class="primary" id="startBtn">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
        </div>
      `);

      document.getElementById("startBtn").onclick = startGame;
    }

    // 1ë‹¨ê³„. ì§ˆë³‘ ì´í•´ í€´ì¦ˆ
    function showIntro() {
      state.step = 1;
      setScreen(`
        <div class="progress">1 / 4ë‹¨ê³„ Â· ì§ˆë³‘ ì´í•´</div>
        <div class="scene-title">ëª¸ ì† í”¼ ê³µì¥ì„ ì§€ì¼œë¼!</div>
        <div class="scene-subtitle">ë°±í˜ˆë³‘ì´ ë­”ì§€, ì•„ì£¼ ì‰½ê²Œ ì•Œì•„ë³´ê¸°</div>

        <div class="dialog-box">
          <div class="character">ğŸ§ª ë‹¤ì˜¨ì´</div>
          <div>
            "ë°±í˜ˆë³‘ì€ ê°ê¸°ì²˜ëŸ¼ ì „ì—¼ë˜ëŠ” ë³‘ì´ ì•„ë‹ˆì•¼.<br>
            <b>ë¼ˆ ì† â€˜í”¼ ê³µì¥(ê³¨ìˆ˜)â€™ì—ì„œ í”¼ë¥¼ ë§Œë“œëŠ” ì„¸í¬ë“¤ì´ ì•„í”ˆ ê±°ì•¼.</b><br><br>
            ê·¸ë˜ì„œ í”¼ë¥¼ ì˜ ëª» ë§Œë“¤ì–´ì„œ<br>
            ê°ì—¼, ë¹ˆí˜ˆ, ë© ê°™ì€ ê²Œ ì˜ ìƒê¸¸ ìˆ˜ ìˆì–´.<br><br>
            ì´ê±´ ì—„ë§ˆ ì•„ë¹  ì˜ëª»ë„, ë‚´ ì˜ëª»ë„ ì•„ë‹ˆì•¼.<br>
            ê·¸ëƒ¥ ì„¸í¬ë“¤ì´ ì•„í”„ê²Œ ë³€í•´ì„œ ìƒê¸°ëŠ” ë³‘ì´ì•¼."
          </div>
        </div>

        <div class="tag">í€´ì¦ˆ</div>
        <div class="dialog-box">
          <div><b>Q. ë°±í˜ˆë³‘ì€ ì–´ë””ì— ë¬¸ì œê°€ ìƒê¸°ëŠ” ë³‘ì¼ê¹Œ?</b></div>
          <div class="button-row">
            <button data-answer="correct" class="option-btn">1) ë¼ˆ ì† í”¼ ê³µì¥(ê³¨ìˆ˜)</button>
            <button data-answer="wrong" class="option-btn">2) ë‹¤ë¦¬ë¼ˆë§Œ ì•„í”ˆ ë³‘</button>
            <button data-answer="wrong" class="option-btn">3) ì¹œêµ¬ì—ê²Œ ì‰½ê²Œ ì˜®ê¸°ëŠ” ë³‘</button>
          </div>
          <div id="feedback" class="feedback"></div>
          <div class="small-label">
            * ì¶”ê°€ ì„¤ëª…: "ì¹œêµ¬ì™€ ë†€ì•„ë„ ë°±í˜ˆë³‘ì€ ì˜®ì§€ ì•ŠëŠ”ë‹¤"ë¥¼ ê¼­ í•œ ë²ˆ ë” ë§í•´ì£¼ë©´ ì¢‹ì•„ìš”.
          </div>
        </div>

        <div class="button-row" style="justify-content:flex-end; margin-top:16px;">
          <button id="nextBtn" class="primary" disabled>ë‹¤ìŒ ë‹¨ê³„ë¡œ â–¶</button>
        </div>
      `);

      const optionButtons = document.querySelectorAll(".option-btn");
      const feedback = document.getElementById("feedback");
      const nextBtn = document.getElementById("nextBtn");

      optionButtons.forEach(btn => {
        btn.onclick = () => {
          const isCorrect = btn.getAttribute("data-answer") === "correct";
          if (isCorrect) {
            feedback.textContent = "ì •ë‹µì´ì•¼! ë°±í˜ˆë³‘ì€ ë¼ˆ ì† í”¼ ê³µì¥ì—ì„œ í”¼ë¥¼ ë§Œë“œëŠ” ì„¸í¬ë“¤ì´ ì•„í”ˆ ë³‘ì´ì•¼.";
            feedback.className = "feedback good";
            state.scoreUnderstanding = 1;
            playVoice("ìµœê³ ì•¼!", "correct");
          } else {
            feedback.textContent = "ì•„ì‰¬ì›Œ! ë‹¤ì‹œ ìƒê°í•´ë³¼ê¹Œ? â€˜í”¼ ê³µì¥â€™ì´ ìˆëŠ” ê³³ì„ ë– ì˜¬ë ¤ë´.";
            feedback.className = "feedback bad";
            state.scoreUnderstanding = 0;
            playVoice("ë‹¤ì‹œ í•´ë³¼ê¹Œ? í•  ìˆ˜ ìˆì–´!", "wrong");
          }
          nextBtn.disabled = false;
        };
      });

      nextBtn.onclick = showHandWashingGame;
    }

    // 2ë‹¨ê³„. ì† ì”»ê¸° ìˆœì„œ ê²Œì„
    function showHandWashingGame() {
      state.step = 2;
      state.selfCareIndex = 0;

      const steps = [
        "ì†ë°”ë‹¥ê³¼ ì†ë°”ë‹¥ì„ ë§ˆì£¼ ë¬¸ì§ˆëŸ¬ìš”",
        "ì†ë“±ì„ ë¬¸ì§ˆëŸ¬ìš”",
        "ì†ê°€ë½ ì‚¬ì´ë¥¼ ê¹¨ë—ì´ ë¬¸ì§ˆëŸ¬ìš”",
        "ì†ê°€ë½ì„ ê¹ì§€ ë¼ê³  ë¬¸ì§ˆëŸ¬ìš”",
        "ì—„ì§€ì†ê°€ë½ì„ ëŒë ¤ê°€ë©° ë¬¸ì§ˆëŸ¬ìš”",
        "ì†í†±ê³¼ ì†ëì„ ë¬¸ì§ˆëŸ¬ìš”"
      ];

      state.handSteps = steps;
      renderHandWashingScene();
    }

    function renderHandWashingScene(feedbackText = "", feedbackType = "") {
      const currentStep = state.selfCareIndex || 0;
      const total = state.handSteps.length;

      const stepText = currentStep < total
        ? `ğŸ‘‰ <b>${currentStep + 1}ë‹¨ê³„</b>ì— ë§ëŠ” ë™ì‘ì„ ê³¨ë¼ë³¼ê¹Œ?`
        : "ëª¨ë“  ë‹¨ê³„ë¥¼ ëëƒˆì–´! ì´ì œ ê²°ê³¼ë¥¼ ë³¼ê¹Œ?";

      const buttonsHtml = state.handSteps.map((t, idx) => {
        return `<button class="hand-btn" data-index="${idx}">${t}</button>`;
      }).join("");

      setScreen(`
        <div class="progress">2 / 4ë‹¨ê³„ Â· ìê°€ê´€ë¦¬</div>
        <div class="scene-title">ì† ì”»ê¸° íˆì–´ë¡œ ì±Œë¦°ì§€</div>
        <div class="scene-subtitle">ê°ì—¼ì„ ë§‰ê¸° ìœ„í•œ í˜! ì† ì”»ê¸° ìˆœì„œë¥¼ ë§ì¶°ë³´ì</div>

        <div class="dialog-box">
          <div class="character">ğŸ§¼ ì„¸ê·  ì§€í‚´ì´ íˆì–´ë¡œ</div>
          <div>
            "ë°±í˜ˆë³‘ ì¹˜ë£Œ ì¤‘ì¸ ì¹œêµ¬ëŠ” <b>ê°ì—¼ì— íŠ¹íˆ ì¡°ì‹¬</b>í•´ì•¼ í•´.<br>
            ê·¸ë˜ì„œ <b>ì† ì”»ê¸°</b>ê°€ ì •ë§ ì •ë§ ì¤‘ìš”í•˜ì§€!<br><br>
            ì•„ë˜ ë™ì‘ ì¤‘ì—ì„œ <b>${currentStep + 1}ë‹¨ê³„</b>ì— ë§ëŠ” ê±¸ ê³¨ë¼ì¤˜!"
          </div>
        </div>

        <div class="dialog-box">
          <div>${stepText}</div>
          <div class="button-row">
            ${buttonsHtml}
          </div>
          <div id="hwFeedback" class="feedback ${feedbackType}">
            ${feedbackText}
          </div>
          <div class="small-label">
            * ì‹¤ì œ êµìœ¡í•  ë• ë…¸ë˜ë‚˜ ë™ì‘ì„ ê°™ì´ í•´ì£¼ë©´ ë” ì¢‹ì•„ìš”.
          </div>
        </div>

        <div class="button-row" style="justify-content:flex-end; margin-top:16px;">
          <button id="skipBtn">ìŠ¤í‚µí•˜ê³  ë‹¤ìŒìœ¼ë¡œ</button>
          <button id="nextBtn" class="primary" ${currentStep < state.handSteps.length ? "disabled" : ""}>
            ë‹¤ìŒ ë‹¨ê³„ë¡œ â–¶
          </button>
        </div>
      `);

      const correctOrder = state.handSteps;
      const handButtons = document.querySelectorAll(".hand-btn");
      const feedbackEl = document.getElementById("hwFeedback");
      const nextBtn = document.getElementById("nextBtn");
      const skipBtn = document.getElementById("skipBtn");

      if (state.selfCareIndex === undefined) state.selfCareIndex = 0;

      handButtons.forEach(btn => {
        btn.onclick = () => {
          if (state.selfCareIndex >= correctOrder.length) return;

          const idx = parseInt(btn.getAttribute("data-index"), 10);
          const isCorrect = (idx === state.selfCareIndex);

          if (isCorrect) {
            feedbackEl.textContent = "ì˜í–ˆì–´! ë‹¤ìŒ ë‹¨ê³„ ì† ì”»ê¸°ë„ í•´ë³´ì!";
            feedbackEl.className = "feedback good";
            state.selfCareIndex++;

            btn.style.opacity = 0.4;
            btn.style.pointerEvents = "none";

            playVoice("ìµœê³ ì•¼!", "correct");

            if (state.selfCareIndex === correctOrder.length) {
              state.scoreSelfCare = 1;
              nextBtn.disabled = false;
            }
          } else {
            feedbackEl.textContent = "ì¡°ê¸ˆ ìˆœì„œê°€ ë‹¬ë¼! ë‹¤ì‹œ í•œ ë²ˆ ìƒê°í•´ë³¼ê¹Œ?";
            feedbackEl.className = "feedback bad";
            playVoice("ë‹¤ì‹œ í•´ë³¼ê¹Œ? í•  ìˆ˜ ìˆì–´!", "wrong");
          }
        };
      });

      nextBtn.onclick = showTreatmentCoop;
      skipBtn.onclick = () => {
        state.scoreSelfCare = 0;
        showTreatmentCoop();
      };
    }

    // 3ë‹¨ê³„. ì¹˜ë£Œ í˜‘ì¡° ìƒí™©
    function showTreatmentCoop() {
      state.step = 3;
      state.coopIndex = 0;
      state.scoreCooperation = 0;

      state.coopScenarios = [
        {
          text: "í•­ì•”ì¹˜ë£Œë¥¼ ë°›ëŠ” ë‚ , ì¡°ê¸ˆ ë¬´ì„­ì§€ë§Œ ê°„í˜¸ì‚¬ ì„ ìƒë‹˜ì´ \"ê¶ê¸ˆí•œ ê±° ìˆìœ¼ë©´ ë‹¤ ë¬¼ì–´ë´ë„ ë¼\"ë¼ê³  ë§í•´ì¤¬ì–´.",
          options: [
            { text: "ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë³¸ë‹¤", good: true },
            { text: "ì•„ë¬´ ë§ë„ ì•ˆ í•˜ê³  ì†ìœ¼ë¡œë§Œ ê±±ì •í•œë‹¤", good: false }
          ]
        },
        {
          text: "ìˆ˜í˜ˆì„ ë°›ì€ ë‹¤ìŒ ë‚ , ëª¸ì´ ë„ˆë¬´ í”¼ê³¤í•˜ê³  í˜ì´ ì—†ì–´.",
          options: [
            { text: "ëª¸ ìƒíƒœë¥¼ ì—„ë§ˆ ì•„ë¹ ë‚˜ ê°„í˜¸ì‚¬ ì„ ìƒë‹˜ì—ê²Œ ë§í•œë‹¤", good: true },
            { text: "ê·¸ëƒ¥ ì°¸ìœ¼ë©´ì„œ ë§ ì•ˆ í•œë‹¤", good: false }
          ]
        },
        {
          text: "ì—´ì´ ë‚˜ëŠ” ê²ƒ ê°™ê³  ë¨¸ë¦¬ê°€ ëµí•´.",
          options: [
            { text: "ë°”ë¡œ ì—„ë§ˆ ì•„ë¹ ë‚˜ ê°„í˜¸ì‚¬ì—ê²Œ ì´ì•¼ê¸°í•œë‹¤", good: true },
            { text: "ê´œì°®ê² ì§€ í•˜ê³  ë„˜ì–´ê°„ë‹¤", good: false }
          ]
        }
      ];

      renderCoopScene();
    }

    function renderCoopScene(feedbackText = "", feedbackType = "") {
      const idx = state.coopIndex;
      const scenarios = state.coopScenarios;

      if (idx >= scenarios.length) {
        showEmotionScene();
        return;
      }

      const s = scenarios[idx];

      const optionsHtml = s.options.map((o, i) => `
        <button class="coop-btn" data-index="${i}">${o.text}</button>
      `).join("");

      setScreen(`
        <div class="progress">3 / 4ë‹¨ê³„ Â· ì¹˜ë£Œ í˜‘ì¡°</div>
        <div class="scene-title">ì¹˜ë£Œ íˆì–´ë¡œ ì„ íƒí•˜ê¸°</div>
        <div class="scene-subtitle">ì–´ë–»ê²Œ í–‰ë™í•˜ë©´ ë‚´ ëª¸ì„ ë” ì˜ ì§€í‚¬ ìˆ˜ ìˆì„ê¹Œ?</div>

        <div class="dialog-box">
          <div class="character">ğŸ§‘â€âš•ï¸ ê°„í˜¸ì‚¬ íˆì–´ë¡œ</div>
          <div>
            "ì¹˜ë£Œë¥¼ ì˜ ë”°ë¼ê°€ë ¤ë©´, <b>ëª¸ ìƒíƒœë¥¼ ë§í•´ì£¼ëŠ” ìš©ê¸°</b>ê°€ ì •ë§ ì¤‘ìš”í•´.<br>
            ì—„ë§ˆ ì•„ë¹ ë‚˜ ê°„í˜¸ì‚¬ ì„ ìƒë‹˜ì€ ë„¤ ì´ì•¼ê¸°ë¥¼ ë“£ê³  ì‹¶ì–´ í•´.<br>
            ì•„ë˜ ìƒí™©ì—ì„œ ë„ˆë¼ë©´ ì–´ë–»ê²Œ í• ì§€ ê³¨ë¼ë³¼ë˜?"
          </div>
        </div>

        <div class="dialog-box">
          <div><b>ìƒí™© ${idx + 1}.</b> ${s.text}</div>
          <div class="button-row" style="margin-top:10px;">
            ${optionsHtml}
          </div>
          <div id="coopFeedback" class="feedback ${feedbackType}">
            ${feedbackText}
          </div>
        </div>

        <div class="button-row" style="justify-content:flex-end; margin-top:16px;">
          <button id="skipBtn">ìŠ¤í‚µí•˜ê³  ë‹¤ìŒìœ¼ë¡œ</button>
        </div>
      `);

      const coopButtons = document.querySelectorAll(".coop-btn");
      const feedbackEl = document.getElementById("coopFeedback");
      const skipBtn = document.getElementById("skipBtn");

      coopButtons.forEach(btn => {
        btn.onclick = () => {
          const optionIdx = parseInt(btn.getAttribute("data-index"), 10);
          const chosen = state.coopScenarios[idx].options[optionIdx];

          if (chosen.good) {
            feedbackEl.textContent = "ë„ˆë¬´ ì˜í–ˆì–´! ëª¸ ìƒíƒœë¥¼ ë§í•˜ëŠ” ê±´ ì •ë§ ì¤‘ìš”í•œ ìš©ê¸°ì•¼.";
            feedbackEl.className = "feedback good";
            state.scoreCooperation++;
            playVoice("ìµœê³ ì•¼!", "correct");
          } else {
            feedbackEl.textContent = "ì¡°ê¸ˆ ìœ„í—˜í•  ìˆ˜ ìˆì–´. ì•„í”Œ ë• ê¼­ ì—„ë§ˆ ì•„ë¹ ì—ê²Œ ë§í•´ì£¼ëŠ” ê²Œ ì¢‹ì•„!";
            feedbackEl.className = "feedback bad";
            playVoice("ë‹¤ì‹œ í•´ë³¼ê¹Œ? í•  ìˆ˜ ìˆì–´!", "wrong");
          }

          coopButtons.forEach(b => b.disabled = true);

          setTimeout(() => {
            state.coopIndex++;
            renderCoopScene();
          }, 900);
        };
      });

      skipBtn.onclick = () => {
        state.coopIndex++;
        renderCoopScene();
      };
    }

    // 4ë‹¨ê³„. ê°ì • í‘œí˜„
    function showEmotionScene() {
      state.step = 4;

      setScreen(`
        <div class="progress">4 / 4ë‹¨ê³„ Â· ë§ˆìŒ í‘œí˜„</div>
        <div class="scene-title">ì˜¤ëŠ˜ ë‚´ ë§ˆìŒ ìƒ‰ê¹”ì€?</div>
        <div class="scene-subtitle">ì§€ê¸ˆ ë‚´ ë§ˆìŒì„ ìƒ‰ê¹”ê³¼ ë§ë¡œ í‘œí˜„í•´ë³´ê¸°</div>

        <div class="dialog-box">
          <div class="character">ğŸ’– ë‹¤ì˜¨ì´</div>
          <div>
            "ì¹˜ë£Œë¥¼ ë°›ë‹¤ ë³´ë©´ <b>ì¢‹ì€ ë‚ </b>ë„ ìˆê³  <b>í˜ë“  ë‚ </b>ë„ ìˆì–´.<br>
            ì–´ë–¤ ë§ˆìŒì´ë“  ê´œì°®ì•„. ì§€ê¸ˆ ë„ˆì˜ ë§ˆìŒì„ ìƒ‰ê¹”ë¡œ í‘œí˜„í•´ ì¤„ë˜?"
          </div>
        </div>

        <div class="dialog-box">
          <div><b>ì˜¤ëŠ˜ ë‚´ ë§ˆìŒì€ ì–´ë–¤ ìƒ‰ì´ë‘ ê°€ì¥ ê°€ê¹Œìš¸ê¹Œ?</b></div>
          <div class="button-row" style="margin-top:10px;">
            <button class="emotion-btn" data-color="pink">í•‘í¬ìƒ‰ (ë”°ëœ»í•˜ê³  í¬ê·¼í•´ìš”)</button>
            <button class="emotion-btn" data-color="blue">íŒŒë€ìƒ‰ (ì¡°ìš©í•˜ê³  ì‚´ì§ ê±±ì •ë¼ìš”)</button>
            <button class="emotion-btn" data-color="yellow">ë…¸ë€ìƒ‰ (ê¸°ëŒ€ë˜ê³  ì‹ ë‚˜ìš”)</button>
            <button class="emotion-btn" data-color="gray">íšŒìƒ‰ (ì¡°ê¸ˆ ì§€ì¹˜ê³  í˜ë“¤ì–´ìš”)</button>
          </div>

          <div style="margin-top:14px; font-size:14px;">
            ë§ˆìŒì— ë“œëŠ” ìƒ‰ì„ ëˆ„ë¥´ê³ , ì•„ë˜ì— ì˜¤ëŠ˜ í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ë³¼ê¹Œ?
          </div>
          <textarea id="emotionText" rows="3" style="width:100%; margin-top:8px; border-radius:12px; border:1px solid #ddd; padding:8px; font-size:14px; box-sizing:border-box;" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ì£¼ì‚¬ ë§ì•˜ëŠ”ë° ìƒê°ë³´ë‹¤ ëœ ì•„íŒ ì–´. ê·¸ë˜ë„ ê¸´ì¥ì€ ëì–´."></textarea>

          <div id="emotionFeedback" class="feedback"></div>
        </div>

        <div class="button-row" style="justify-content:flex-end; margin-top:16px;">
          <button id="finishBtn" class="primary">ê²Œì„ ê²°ê³¼ ë³´ê¸°</button>
        </div>
      `);

      let chosenColor = null;
      const emotionBtns = document.querySelectorAll(".emotion-btn");
      const feedbackEl = document.getElementById("emotionFeedback");
      const finishBtn = document.getElementById("finishBtn");

      emotionBtns.forEach(btn => {
        btn.onclick = () => {
          chosenColor = btn.getAttribute("data-color");
          emotionBtns.forEach(b => b.style.outline = "none");
          btn.style.outline = "2px solid #ff80d0";

          let message = "";
          if (chosenColor === "pink") {
            message = "ë”°ëœ»í•œ ë§ˆìŒì´ ëŠê»´ì ¸. ì´ëŸ° ë§ˆìŒì´ ìˆëŠ” ë„ˆê°€ ë„ˆë¬´ ì†Œì¤‘í•´.";
          } else if (chosenColor === "blue") {
            message = "ê±±ì •ë˜ëŠ” ë§ˆìŒë„ ê´œì°®ì•„. ê±±ì •ì„ ë§ë¡œ êº¼ë‚´ì£¼ëŠ” ê²ƒë§Œìœ¼ë¡œë„ í° ìš©ê¸°ì•¼.";
          } else if (chosenColor === "yellow") {
            message = "ì„¤ë ˆê³  ê¸°ëŒ€ë˜ëŠ” ë§ˆìŒ, ë¶„ëª… ì¢‹ì€ í˜ì´ ë  ê±°ì•¼!";
          } else if (chosenColor === "gray") {
            message = "ì§€ì¹˜ê³  í˜ë“  ë‚ ë„ ë‹¹ì—°íˆ ìˆì–´. ê·¸ëŸ´ ë• â€˜ì‰¬ì–´ê°€ëŠ” ìš©ê¸°â€™ë„ í•„ìš”í•´.";
          }
          feedbackEl.textContent = message;
          feedbackEl.className = "feedback good";
        };
      });

      finishBtn.onclick = () => {
        const text = document.getElementById("emotionText").value.trim();
        showResult(chosenColor, text);
      };
    }

    // ê²°ê³¼ í™”ë©´
    function showResult(chosenColor, text) {
      const totalScore =
        state.scoreUnderstanding +
        state.scoreSelfCare +
        state.scoreCooperation;

      let levelText = "";
      if (totalScore === 3) {
        levelText = "ë„ˆëŠ” <b>ìŠˆí¼ íˆì–´ë¡œ ë ˆë²¨</b>ì´ì•¼! ëª¸ë„, ë§ˆìŒë„, ì¹˜ë£Œ í˜‘ì¡°ë„ ìµœê³ !";
      } else if (totalScore === 2) {
        levelText = "ê±°ì˜ ë‹¤ ì™”ì–´! ì´ë¯¸ ë©‹ì§„ íˆì–´ë¡œê³ , ì•ìœ¼ë¡œ ë” ì˜í•  ìˆ˜ ìˆì„ ê±°ì•¼.";
      } else {
        levelText = "ì§€ê¸ˆë¶€í„° í•˜ë‚˜ì”© ì²œì²œíˆ ë°°ì›Œê°€ë©´ ë¼. ì´ë¯¸ ì‹œì‘í•œ ê²ƒë§Œìœ¼ë¡œë„ ì¶©ë¶„íˆ ëŒ€ë‹¨í•´!";
      }

      let colorTag = "";
      if (chosenColor) {
        const label =
          chosenColor === "pink" ? "ë”°ëœ»í•œ í•‘í¬ ë§ˆìŒ" :
          chosenColor === "blue" ? "ì¡°ìš©í•œ íŒŒë‘ ë§ˆìŒ" :
          chosenColor === "yellow" ? "ë°˜ì§ì´ëŠ” ë…¸ë‘ ë§ˆìŒ" :
          "ì‚´ì§ ì§€ì¹œ íšŒìƒ‰ ë§ˆìŒ";
        colorTag = `<span class="pill">${label}</span>`;
      }

      const safeText = text
        ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;")
        : "";

      const userText = text
        ? `<div style="margin-top:10px; font-size:13px; color:#555;">
            ğŸ‘‰ ë„¤ê°€ ì ì–´ì¤€ ë§ˆìŒ í•œ ë¬¸ì¥<br>
            <i>"${safeText}"</i>
           </div>`
        : `<div style="margin-top:10px; font-size:13px; color:#777;">
            ì˜¤ëŠ˜ì€ ë§ë¡œ ì“°ê¸° ì¡°ê¸ˆ ì–´ë µë‹¤ë©´, ë‹¤ìŒì— ë‹¤ì‹œ ì ì–´ë´ë„ ì¢‹ì•„ :)
           </div>`;

      // ê²°ê³¼ ì €ì¥í•˜ê¸°
      const now = new Date();
      const resultObj = {
        time: now.toLocaleString("ko-KR"),
        understanding: state.scoreUnderstanding,
        selfCare: state.scoreSelfCare,
        cooperation: state.scoreCooperation,
        total: totalScore
      };
      saveResult(resultObj);

      const allResults = loadResults();
      let recordsHtml = "";

      if (allResults.length > 0) {
        const rows = allResults.map((r, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${r.time}</td>
            <td>${r.understanding}</td>
            <td>${r.selfCare}</td>
            <td>${r.cooperation}</td>
            <td>${r.total}</td>
          </tr>
        `).join("");

        recordsHtml = `
          <div class="dialog-box">
            <div class="character">ğŸ“Š ì§€ê¸ˆê¹Œì§€ í”Œë ˆì´ ê¸°ë¡</div>
            <div class="small-label">
              * ê°™ì€ ì»´í“¨í„°Â·ê°™ì€ ë¸Œë¼ìš°ì €ì—ì„œ í•œ ê¸°ë¡ì´ ìŒ“ì—¬ìš”. (localStorage ì‚¬ìš©)
            </div>
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>ì‹œê°„</th>
                  <th>ì§ˆë³‘</th>
                  <th>ì†ì”»ê¸°</th>
                  <th>í˜‘ì¡°</th>
                  <th>ì´ì </th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        `;
      }

      setScreen(`
        <div class="scene-title">íˆì–´ë¡œ ê²°ê³¼ ì¹´ë“œ</div>
        <div class="scene-subtitle">ë°±í˜ˆë³‘ ì¹œêµ¬ë¥¼ ìœ„í•œ ëª¸Â·ë§ˆìŒ íˆì–´ë¡œ ë˜ê¸°</div>

        <div class="dialog-box">
          <div class="character">ğŸŒŸ íˆì–´ë¡œ í‰ê°€</div>
          <div>
            ${levelText}
          </div>
          <div style="margin-top:8px;">
            <span class="pill">ì§ˆë³‘ ì´í•´: ${state.scoreUnderstanding ? "ğŸ‘" : "ì—°ìŠµ í•„ìš”"}</span>
            <span class="pill">ì† ì”»ê¸°: ${state.scoreSelfCare ? "ğŸ‘" : "ì—°ìŠµ í•„ìš”"}</span>
            <span class="pill">ì¹˜ë£Œ í˜‘ì¡°: ${state.scoreCooperation ? "ğŸ‘" : "ì—°ìŠµ í•„ìš”"}</span>
          </div>
          <div style="margin-top:8px;">
            ${colorTag}
          </div>
          ${userText}
        </div>

        <div class="dialog-box">
          <div class="character">ğŸ‘©â€âš•ï¸ êµìœ¡ í¬ì¸íŠ¸ (êµì‚¬ìš©)</div>
          <ul class="list">
            <li>ë°±í˜ˆë³‘ì€ â€œí”¼ ê³µì¥(ê³¨ìˆ˜)â€ ì„¤ëª… ìœ„ì£¼ë¡œ, ì£„ì±…ê°Â·ì „ì—¼ì— ëŒ€í•œ ì˜¤í•´ ë°”ë¡œì¡ê¸°</li>
            <li>ì† ì”»ê¸°ëŠ” ì‹¤ì œ ë™ì‘Â·ë…¸ë˜ì™€ í•¨ê»˜ ë°˜ë³µí•˜ë©´ ê¸°ì–µì— ë” ì˜ ë‚¨ìŒ</li>
            <li>ëª¸ ìƒíƒœÂ·ê°ì •ì„ ë§ë¡œ í‘œí˜„í•˜ëŠ” ì—°ìŠµì€ ì¹˜ë£Œ í˜‘ì¡°ì— ì§ì ‘ì ìœ¼ë¡œ ë„ì›€</li>
            <li>ì–´ë–¤ ê°ì •ë„ â€œê´œì°®ë‹¤â€ëŠ” ë©”ì‹œì§€ë¥¼ ë°˜ë³µì ìœ¼ë¡œ ì „ë‹¬í•˜ê¸°</li>
            <li>ì ìˆ˜ ê¸°ë¡ì€ ì•„ì´ ê°œë³„ ë³€í™”Â·ë°˜ë³µ êµìœ¡ ì •ë„ë¥¼ íŒŒì•…í•˜ëŠ” ë° í™œìš© ê°€ëŠ¥</li>
          </ul>
        </div>

        ${recordsHtml}

        <div class="button-row" style="justify-content:space-between; margin-top:16px;">
          <button id="restartBtn">ë‹¤ì‹œ í•´ë³´ê¸°</button>
          <button id="endBtn" class="primary">ê²Œì„ ë! ìˆ˜ê³ í–ˆì–´ ğŸ’–</button>
        </div>
      `);

      document.getElementById("restartBtn").onclick = () => {
        startGame();
      };

      document.getElementById("endBtn").onclick = () => {
        showStartScreen(); // ì—¬ê¸°ì„œ ë©œë¡œë””ë„ ë©ˆì¶¤
      };
    }

    // ì²˜ìŒ ì‹¤í–‰
    showStartScreen();
  </script>
</body>
</html>
